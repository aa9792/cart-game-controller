<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è·‘è·‘å¡ä¸è»Š - é›™äººå°æˆ°æ§åˆ¶å° (å¯è‡ªè¨‚é¡Œç›®ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap');

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f0fdf4;
            background-image: radial-gradient(#cbd5e1 1px, transparent 1px);
            background-size: 20px 20px;
        }
        
        .shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }
        
        .digital-font { font-family: 'Share Tech Mono', monospace; }
        .hidden-section { display: none !important; }
        .btn-press:active { transform: translateY(2px); box-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        
        /* Transition for car movement */
        .kart-transition { transition: left 0.5s cubic-bezier(0.4, 0.0, 0.2, 1); }
        
        /* Cell Highlight Animations */
        .active-cell-p1 { background-color: #fee2e2; box-shadow: inset 0 0 10px #ef4444; transition: all 0.3s; }
        .active-cell-p2 { background-color: #dbeafe; box-shadow: inset 0 0 10px #3b82f6; transition: all 0.3s; }

        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4">

    <!-- 1. Start Overlay -->
    <div id="startOverlay" class="fixed inset-0 bg-black/90 z-50 flex items-center justify-center">
        <div class="bg-white p-8 rounded-2xl text-center max-w-sm mx-4 border-4 border-yellow-500 shadow-[0_0_30px_rgba(234,179,8,0.6)]">
            <h1 class="text-3xl font-black mb-4 text-gray-800">ğŸ® é›™äººå°æˆ°æ§åˆ¶å°</h1>
            <p class="mb-4 text-gray-600">è«‹ç¢ºèªéŸ³é‡å·²é–‹å•Ÿ</p>
            <button onclick="testSound()" class="mb-6 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-full text-sm flex items-center justify-center mx-auto transition">ğŸ”Š æ¸¬è©¦è²éŸ³</button>
            <button onclick="enterSystem()" class="w-full bg-blue-600 hover:bg-blue-700 text-white text-xl font-bold py-4 px-8 rounded-xl shadow-lg transform transition hover:scale-105">å•Ÿå‹•ç³»çµ± GO!</button>
        </div>
    </div>

    <!-- Music Toggle -->
    <button id="musicToggleBtn" onclick="toggleMusic()" class="hidden-section fixed top-4 right-4 z-50 bg-gray-900/80 text-white p-3 rounded-full hover:bg-gray-800 border-2 border-white/50 backdrop-blur-sm transition">ğŸµ éŸ³æ¨‚: é–‹</button>

    <!-- 2. Main Menu -->
    <div id="mainMenu" class="hidden-section w-full max-w-4xl animate-fade-in mt-10">
        <header class="text-center mb-10">
            <h1 class="text-4xl md:text-5xl font-black text-gray-800 mb-2 tracking-wider italic transform -skew-x-6">è·‘è·‘å¡ä¸è»Š <span class="text-red-600">é›™äººå°æˆ°ç‰ˆ</span></h1>
            <p class="text-gray-600 font-bold text-lg">è«‹é¸æ“‡åŠŸèƒ½æ¨¡å¼</p>
        </header>

        <div class="grid md:grid-cols-2 gap-8 px-4">
            <!-- Mode 1: Dual Timer -->
            <div onclick="switchMode('timer')" class="bg-white border-4 border-red-500 rounded-3xl p-6 cursor-pointer hover:shadow-2xl hover:-translate-y-2 transition-all group relative overflow-hidden">
                <div class="absolute right-0 top-0 bg-red-500 text-white font-bold px-4 py-1 rounded-bl-xl z-10">è£åˆ¤å°ˆç”¨</div>
                <div class="flex flex-col items-center text-center z-10 relative">
                    <div class="text-7xl mb-4 group-hover:scale-110 transition-transform">ğŸï¸</div>
                    <h2 class="text-3xl font-black text-gray-800 mb-2">é›™äººç«¶é€Ÿè¨ˆæ™‚</h2>
                    <p class="text-gray-500 font-bold">åŒæ­¥èµ·è·‘ / ç¨ç«‹æˆç¸¾</p>
                    <div class="mt-4 bg-red-100 text-red-800 px-4 py-2 rounded-lg text-sm font-bold">å«æ’è¡Œæ¦œç´€éŒ„</div>
                </div>
            </div>

            <!-- Mode 2: Quiz -->
            <div onclick="switchMode('quiz')" class="bg-white border-4 border-purple-500 rounded-3xl p-6 cursor-pointer hover:shadow-2xl hover:-translate-y-2 transition-all group relative overflow-hidden">
                <div class="absolute right-0 top-0 bg-purple-500 text-white font-bold px-4 py-1 rounded-bl-xl z-10">é—œä¸»å°ˆç”¨</div>
                <div class="flex flex-col items-center text-center z-10 relative">
                    <div class="text-7xl mb-4 group-hover:scale-110 transition-transform">ğŸ²</div>
                    <h2 class="text-3xl font-black text-gray-800 mb-2">æ™ºåŠ›æ¶ç­”æ‹‰åŠ›è³½</h2>
                    <p class="text-gray-500 font-bold">æ¥µé€Ÿæ¶ç­”æ¨¡å¼</p>
                    <div class="mt-4 bg-purple-100 text-purple-800 px-4 py-2 rounded-lg text-sm font-bold">å¯è‡ªè¨‚é¡Œåº«</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 3. Dual Timer Mode Section -->
    <div id="timerMode" class="hidden-section w-full max-w-5xl mt-4">
        <button onclick="backToMenu()" class="mb-4 text-gray-600 font-bold hover:text-gray-900 flex items-center bg-white px-4 py-2 rounded-full shadow">â¬…ï¸ è¿”å›é¸å–®</button>
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <!-- Left: Timer Controls -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Main Control Panel -->
                <div class="bg-gray-900 rounded-3xl p-6 border-8 border-gray-700 shadow-2xl relative">
                    <!-- Status Header -->
                    <div class="flex justify-between items-center mb-6 border-b border-gray-700 pb-4">
                        <h2 class="text-2xl font-bold text-gray-400">DUAL RACE TIMER</h2>
                        <button onclick="startRaceSequence()" class="bg-yellow-500 hover:bg-yellow-400 text-black font-black py-2 px-6 rounded-full shadow-lg transform active:scale-95 transition flex items-center gap-2 animate-pulse">
                            ğŸ“£ é³´ç¬›èµ·è·‘
                        </button>
                    </div>

                    <!-- Timers Grid -->
                    <div class="grid grid-cols-2 gap-4 mb-8">
                        
                        <!-- P1 Red -->
                        <div class="bg-red-900/30 rounded-2xl p-4 border-2 border-red-500/50 flex flex-col items-center">
                            <div class="text-red-400 font-bold text-lg mb-2">ğŸ”´ PLAYER 1</div>
                            <div id="timerDisplayP1" class="text-5xl md:text-6xl text-red-500 digital-font font-bold tabular-nums drop-shadow-[0_0_8px_rgba(239,68,68,0.5)]">
                                00:00<span class="text-2xl md:text-3xl opacity-70">.00</span>
                            </div>
                            <button id="btnP1" onclick="playerFinish(1)" class="mt-4 w-full bg-red-600 hover:bg-red-500 disabled:bg-gray-700 disabled:text-gray-500 text-white font-black py-3 rounded-xl btn-press border-b-4 border-red-800 active:border-b-0 transition">
                                ğŸ P1 æŠµé”
                            </button>
                        </div>

                        <!-- P2 Blue -->
                        <div class="bg-blue-900/30 rounded-2xl p-4 border-2 border-blue-500/50 flex flex-col items-center">
                            <div class="text-blue-400 font-bold text-lg mb-2">ğŸ”µ PLAYER 2</div>
                            <div id="timerDisplayP2" class="text-5xl md:text-6xl text-blue-500 digital-font font-bold tabular-nums drop-shadow-[0_0_8px_rgba(59,130,246,0.5)]">
                                00:00<span class="text-2xl md:text-3xl opacity-70">.00</span>
                            </div>
                            <button id="btnP2" onclick="playerFinish(2)" class="mt-4 w-full bg-blue-600 hover:bg-blue-500 disabled:bg-gray-700 disabled:text-gray-500 text-white font-black py-3 rounded-xl btn-press border-b-4 border-blue-800 active:border-b-0 transition">
                                ğŸ P2 æŠµé”
                            </button>
                        </div>
                    </div>

                    <!-- Reset Control -->
                    <button onclick="resetDualStopwatch()" class="w-full bg-gray-700 hover:bg-gray-600 text-gray-300 font-bold py-3 rounded-xl transition">
                        ğŸ”„ é‡ç½®æ¯”è³½
                    </button>
                </div>
            </div>

            <!-- Right: Leaderboard -->
            <div class="bg-white rounded-3xl p-6 border-4 border-gray-300 shadow-xl h-full flex flex-col">
                <h3 class="text-xl font-black text-gray-800 mb-4 flex items-center gap-2">
                    ğŸ† å°æˆ°ç´€éŒ„è¡¨
                    <span id="raceCountBadge" class="bg-gray-800 text-white text-xs px-2 py-1 rounded-full">0</span>
                </h3>
                <div class="flex-1 overflow-y-auto max-h-[400px]">
                    <table class="w-full text-sm text-left">
                        <thead class="text-xs text-gray-500 uppercase bg-gray-100 sticky top-0">
                            <tr>
                                <th class="px-3 py-2 rounded-tl-lg">å ´æ¬¡</th>
                                <th class="px-3 py-2 text-red-600">P1 æˆç¸¾</th>
                                <th class="px-3 py-2 text-blue-600">P2 æˆç¸¾</th>
                                <th class="px-3 py-2 rounded-tr-lg">å‹è€…</th>
                            </tr>
                        </thead>
                        <tbody id="scoreTableBody" class="font-mono">
                            <!-- Rows will be added here -->
                        </tbody>
                    </table>
                    <div id="emptyState" class="text-center text-gray-400 py-8">
                        å°šæœªæœ‰æ¯”è³½ç´€éŒ„
                    </div>
                </div>
                <button onclick="clearLeaderboard()" class="mt-4 text-xs text-red-500 underline hover:text-red-700 text-center w-full">æ¸…é™¤æ‰€æœ‰ç´€éŒ„</button>
            </div>
        </div>
    </div>

    <!-- 4. Quiz Mode Section -->
    <div id="quizMode" class="hidden-section w-full max-w-2xl mt-4">
        <div class="flex justify-between items-center mb-4">
            <button onclick="backToMenu()" class="text-gray-600 font-bold hover:text-gray-900 flex items-center bg-white px-4 py-2 rounded-full shadow">â¬…ï¸ è¿”å›é¸å–®</button>
            <button onclick="openQuestionSettings()" class="text-purple-600 font-bold hover:text-purple-900 flex items-center bg-white px-4 py-2 rounded-full shadow border border-purple-200">âš™ï¸ é¡Œç›®è¨­å®š</button>
        </div>

        <!-- Top Status Bar -->
        <div class="flex justify-between items-center mb-4 bg-gray-800 text-white p-4 rounded-2xl shadow-lg border-2 border-gray-600">
            <div class="flex items-center gap-2">
                <div class="text-2xl">â±ï¸</div>
                <div id="quizTotalTimer" class="font-mono text-3xl font-bold text-yellow-400">00:00</div>
            </div>
            <div class="flex items-center gap-2">
                <span class="text-sm font-bold text-gray-400">ç‹€æ…‹:</span>
                <span id="quizStatusBadge" class="px-4 py-1 rounded-full font-black bg-gray-600 text-white text-lg">ç­‰å¾…æ¶ç­”</span>
            </div>
        </div>

        <div class="w-full bg-white rounded-3xl shadow-2xl overflow-hidden border-4 border-gray-800 relative mb-6">
            <div class="bg-yellow-400 p-2 text-center border-b-4 border-gray-800">
                <h1 class="text-xl font-black text-gray-900 tracking-wider">ğŸš© æ™¯é»æ™ºåŠ›æ¶ç­”è³½</h1>
            </div>

            <!-- Question & Interaction Area -->
            <div id="questionSection" class="flex flex-col h-full min-h-[450px]">
                <div class="w-full h-4 bg-gray-200 border-b-2 border-black">
                    <div id="timerBar" class="h-full bg-green-500 w-full"></div>
                </div>
                <div class="p-6 flex-1 flex flex-col">
                    <div class="mb-4">
                        <span id="topicTag" class="inline-block bg-purple-600 text-white text-xs font-bold px-2 py-1 rounded mb-2">é¡Œç›®</span>
                        <h2 id="questionText" class="text-2xl font-bold text-gray-800 leading-tight">é¡Œç›®è®€å–ä¸­...</h2>
                    </div>

                    <!-- Buzzer Buttons Area -->
                    <div id="buzzerArea" class="flex-1 flex gap-4 items-center justify-center py-4">
                        <button onclick="teamBuzzIn(1)" class="flex-1 h-32 bg-red-600 hover:bg-red-500 text-white text-3xl font-black rounded-2xl border-b-8 border-red-900 active:border-b-0 active:translate-y-2 shadow-xl transition-all flex flex-col items-center justify-center group">
                            <span class="text-5xl mb-2 group-hover:scale-110 transition-transform">ğŸš¨</span>
                            ç´…éšŠæ¶ç­”
                        </button>
                        <button onclick="teamBuzzIn(2)" class="flex-1 h-32 bg-blue-600 hover:bg-blue-500 text-white text-3xl font-black rounded-2xl border-b-8 border-blue-900 active:border-b-0 active:translate-y-2 shadow-xl transition-all flex flex-col items-center justify-center group">
                            <span class="text-5xl mb-2 group-hover:scale-110 transition-transform">ğŸš¨</span>
                            è—éšŠæ¶ç­”
                        </button>
                    </div>

                    <!-- Answer Options Area -->
                    <div id="optionsContainer" class="hidden space-y-3 flex-1"></div>
                    
                    <div class="mt-4 text-center">
                        <span id="timerText" class="text-4xl font-black text-red-500 font-mono">10</span>
                    </div>
                </div>
            </div>

            <!-- Overlays -->
            <div id="resultOverlay" class="hidden absolute inset-0 bg-white/95 z-30 flex flex-col items-center justify-center p-6 text-center">
                <div id="resultIcon" class="text-8xl mb-4">â­•</div>
                <h2 id="resultTitle" class="text-3xl font-black mb-2">ç­”å°äº†ï¼</h2>
                <p id="resultMessage" class="text-xl font-bold text-gray-600 mb-8">å‰é€²ä¸€æ­¥ï¼</p>
                <button onclick="handleNextRound()" class="bg-gray-800 text-white font-bold py-3 px-8 rounded-lg text-lg">ä¸‹ä¸€é¡Œ</button>
            </div>

            <div id="winnerOverlay" class="hidden absolute inset-0 bg-yellow-300 z-40 flex flex-col items-center justify-center p-6 text-center border-4 border-black">
                <div class="text-8xl mb-4 animate-bounce">ğŸ†</div>
                <h2 id="winnerTitle" class="text-5xl font-black mb-2 text-black drop-shadow-md">ç´…éšŠç²å‹ï¼</h2>
                <p class="text-2xl font-bold text-gray-800 mb-4">ç¸½è€—æ™‚</p>
                <div id="finalTime" class="text-4xl font-mono font-black text-red-600 mb-8 border-2 border-black px-4 py-2 bg-white rounded-lg">00:45</div>
                <button onclick="resetGame()" class="bg-black hover:bg-gray-800 text-white font-bold py-4 px-10 rounded-xl text-xl transition-transform hover:scale-105">å†ä¾†ä¸€å ´</button>
            </div>
        </div>

        <!-- Track Visualization -->
        <div class="bg-gray-200 rounded-3xl p-4 border-4 border-gray-400 shadow-inner">
            <h3 class="text-center font-bold text-gray-500 mb-2 text-sm tracking-widest">RACE TRACK (6 STEPS)</h3>
            
            <!-- Lane 1: P1 Red -->
            <div class="relative h-16 bg-white rounded-xl mb-4 border-2 border-gray-300 flex items-center overflow-hidden" id="laneP1">
                <!-- Start Line Cell (0) -->
                <div class="flex-1 h-full border-r border-dashed border-gray-300 relative flex items-center justify-center bg-gray-50 text-xs font-bold text-gray-300" id="p1-cell-0">START</div>
                <!-- Steps 1-5 -->
                <div class="flex-1 h-full border-r border-dashed border-gray-300 relative" id="p1-cell-1"></div>
                <div class="flex-1 h-full border-r border-dashed border-gray-300 relative" id="p1-cell-2"></div>
                <div class="flex-1 h-full border-r border-dashed border-gray-300 relative" id="p1-cell-3"></div>
                <div class="flex-1 h-full border-r border-dashed border-gray-300 relative" id="p1-cell-4"></div>
                <div class="flex-1 h-full border-r border-dashed border-gray-300 relative" id="p1-cell-5"></div>
                <!-- Finish Cell (6) -->
                <div class="flex-1 h-full relative bg-yellow-100 flex items-center justify-center font-black text-xs text-yellow-600" id="p1-cell-6">FIN</div>

                <!-- Kart -->
                <div id="kartP1" class="absolute z-10 text-3xl transform -translate-x-1/2 kart-transition pointer-events-none" style="left: 7%; top: 50%; transform: translate(-50%, -50%) scaleX(-1);">ğŸï¸</div>
                <div class="absolute z-10 left-1 top-1 text-[10px] font-bold text-red-500 bg-white/80 px-1 rounded">P1</div>
            </div>

            <!-- Lane 2: P2 Blue -->
            <div class="relative h-16 bg-white rounded-xl border-2 border-gray-300 flex items-center overflow-hidden" id="laneP2">
                <!-- Start Line Cell (0) -->
                <div class="flex-1 h-full border-r border-dashed border-gray-300 relative flex items-center justify-center bg-gray-50 text-xs font-bold text-gray-300" id="p2-cell-0">START</div>
                <!-- Steps 1-5 -->
                <div class="flex-1 h-full border-r border-dashed border-gray-300 relative" id="p2-cell-1"></div>
                <div class="flex-1 h-full border-r border-dashed border-gray-300 relative" id="p2-cell-2"></div>
                <div class="flex-1 h-full border-r border-dashed border-gray-300 relative" id="p2-cell-3"></div>
                <div class="flex-1 h-full border-r border-dashed border-gray-300 relative" id="p2-cell-4"></div>
                <div class="flex-1 h-full border-r border-dashed border-gray-300 relative" id="p2-cell-5"></div>
                <!-- Finish Cell (6) -->
                <div class="flex-1 h-full relative bg-yellow-100 flex items-center justify-center font-black text-xs text-yellow-600" id="p2-cell-6">FIN</div>

                <!-- Kart -->
                <div id="kartP2" class="absolute z-10 text-3xl transform -translate-x-1/2 kart-transition filter hue-rotate-[200deg] pointer-events-none" style="left: 7%; top: 50%; transform: translate(-50%, -50%) scaleX(-1);">ğŸï¸</div>
                <div class="absolute z-10 left-1 top-1 text-[10px] font-bold text-blue-500 bg-white/80 px-1 rounded">P2</div>
            </div>
        </div>
    </div>

    <!-- 5. Settings Modal (New Feature) -->
    <div id="settingsOverlay" class="hidden fixed inset-0 bg-black/80 z-[60] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-3xl flex flex-col max-h-[90vh]">
            <div class="p-4 border-b flex justify-between items-center bg-gray-100 rounded-t-2xl">
                <h3 class="text-xl font-bold text-gray-800">âš™ï¸ ç·¨è¼¯é¡Œç›®åº« (JSONæ ¼å¼)</h3>
                <button onclick="closeSettings()" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <div class="p-4 flex-1 flex flex-col gap-2 overflow-hidden">
                <p class="text-sm text-gray-600 bg-blue-50 p-2 rounded border border-blue-200">
                    <strong>èªªæ˜ï¼š</strong>è«‹ä¿æŒ JSON æ ¼å¼ã€‚<code>answer</code> æ¬„ä½ 0 ä»£è¡¨ç¬¬ä¸€å€‹é¸é …ï¼Œ1 ä»£è¡¨ç¬¬äºŒå€‹ï¼Œä»¥æ­¤é¡æ¨ã€‚
                </p>
                <textarea id="jsonInput" class="flex-1 w-full border-2 border-gray-300 rounded-lg p-3 font-mono text-sm focus:border-blue-500 focus:outline-none" spellcheck="false"></textarea>
            </div>
            <div class="p-4 border-t bg-gray-50 rounded-b-2xl flex justify-between gap-4">
                <button onclick="resetDefaultQuestions()" class="text-red-500 font-bold hover:text-red-700 underline text-sm">æ¢å¾©é è¨­é¡Œåº«</button>
                <div class="flex gap-2">
                    <button onclick="closeSettings()" class="px-4 py-2 rounded-lg text-gray-600 font-bold hover:bg-gray-200">å–æ¶ˆ</button>
                    <button onclick="saveCustomQuestions()" class="px-6 py-2 rounded-lg bg-purple-600 text-white font-bold hover:bg-purple-700 shadow-lg">ğŸ’¾ å„²å­˜ä¸¦å¥—ç”¨</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- System & Audio Core ---
        let audioCtx = null;
        
        // --- Music System ---
        let isMusicEnabled = true;
        let isMusicPlaying = false;
        let nextNoteTime = 0.0;
        let scheduleAheadTime = 0.1;
        let current16thNote = 0;
        let musicTimerID = null;
        let musicTempo = 150;

        function ensureAudioContext() {
            if (!audioCtx) {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                audioCtx = new AudioContext();
            }
            if (audioCtx.state === 'suspended') { audioCtx.resume(); }
        }

        function toggleMusic() {
            isMusicEnabled = !isMusicEnabled;
            const btn = document.getElementById('musicToggleBtn');
            if (isMusicEnabled) {
                btn.innerText = "ğŸµ éŸ³æ¨‚: é–‹";
                btn.classList.remove('bg-red-900/80'); btn.classList.add('bg-gray-900/80');
                if ((!document.getElementById('timerMode').classList.contains('hidden-section') || 
                     !document.getElementById('quizMode').classList.contains('hidden-section'))) {
                    startMusic();
                }
            } else {
                btn.innerText = "ğŸ”‡ éŸ³æ¨‚: é—œ";
                btn.classList.add('bg-red-900/80'); btn.classList.remove('bg-gray-900/80');
                stopMusic();
            }
        }

        // --- Music Synthesis ---
        function nextNote() {
            const secondsPerBeat = 60.0 / musicTempo;
            nextNoteTime += 0.25 * secondsPerBeat;
            current16thNote = (current16thNote + 1) % 16;
        }

        function scheduleNote(beatNumber, time) {
            if (!isMusicEnabled) return;
            if (beatNumber % 4 === 0) playDrum(time, 150, 0.01, 0.5);
            if (beatNumber % 8 === 4) playSnare(time);
            if (beatNumber % 2 !== 0) playHiHat(time);
            
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.type = 'sawtooth';
            
            let freq = 65.41; // C2
            if (beatNumber < 4) freq = 65.41;
            else if (beatNumber < 8) freq = 77.78; // Eb
            else if (beatNumber < 12) freq = 87.31; // F
            else freq = 98.00; // G
            if (beatNumber % 2 !== 0) freq *= 2; 

            osc.frequency.setValueAtTime(freq, time);
            gain.gain.setValueAtTime(0.1, time);
            gain.gain.exponentialRampToValueAtTime(0.001, time + 0.1);
            osc.start(time); osc.stop(time + 0.1);
        }

        function playDrum(time, freq, attack, decay) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.frequency.setValueAtTime(freq, time);
            osc.frequency.exponentialRampToValueAtTime(0.01, time + 0.5);
            gain.gain.setValueAtTime(0.5, time);
            gain.gain.exponentialRampToValueAtTime(0.01, time + 0.5);
            osc.start(time); osc.stop(time + 0.5);
        }

        function playSnare(time) {
            const bufferSize = audioCtx.sampleRate * 0.1;
            const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
            const data = buffer.getChannelData(0);
            for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
            const noise = audioCtx.createBufferSource();
            noise.buffer = buffer;
            const filter = audioCtx.createBiquadFilter();
            filter.type = 'highpass'; filter.frequency.value = 1000;
            const gain = audioCtx.createGain();
            gain.gain.setValueAtTime(0.3, time);
            gain.gain.exponentialRampToValueAtTime(0.01, time + 0.1);
            noise.connect(filter); filter.connect(gain); gain.connect(audioCtx.destination);
            noise.start(time);
        }

        function playHiHat(time) {
            const bufferSize = audioCtx.sampleRate * 0.05;
            const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
            const data = buffer.getChannelData(0);
            for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
            const noise = audioCtx.createBufferSource();
            noise.buffer = buffer;
            const filter = audioCtx.createBiquadFilter();
            filter.type = 'highpass'; filter.frequency.value = 5000;
            const gain = audioCtx.createGain();
            gain.gain.setValueAtTime(0.1, time);
            gain.gain.exponentialRampToValueAtTime(0.01, time + 0.05);
            noise.connect(filter); filter.connect(gain); gain.connect(audioCtx.destination);
            noise.start(time);
        }

        function scheduler() {
            while (nextNoteTime < audioCtx.currentTime + scheduleAheadTime) {
                scheduleNote(current16thNote, nextNoteTime);
                nextNote();
            }
        }

        function startMusic() {
            if (!isMusicEnabled || isMusicPlaying) return;
            ensureAudioContext();
            isMusicPlaying = true;
            current16thNote = 0;
            nextNoteTime = audioCtx.currentTime + 0.1;
            musicTimerID = setInterval(scheduler, 25);
            document.getElementById('musicToggleBtn').classList.remove('hidden-section');
        }

        function stopMusic() {
            isMusicPlaying = false;
            if (musicTimerID) clearInterval(musicTimerID);
            musicTimerID = null;
        }

        function playSound(type) {
            ensureAudioContext();
            if (!audioCtx) return;
            
            const now = audioCtx.currentTime;

            // Common routing for simple sounds
            if (type !== 'gunshot' && type !== 'cheer') {
                const osc = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();
                osc.connect(gainNode);
                gainNode.connect(audioCtx.destination);

                if (type === 'tick') {
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(800, now);
                    osc.frequency.exponentialRampToValueAtTime(100, now + 0.1);
                    gainNode.gain.setValueAtTime(0.3, now);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                    osc.start(now); osc.stop(now + 0.1);
                } else if (type === 'correct') {
                    osc.type = 'triangle';
                    osc.frequency.setValueAtTime(523.25, now); 
                    osc.frequency.setValueAtTime(659.25, now + 0.1);
                    osc.frequency.setValueAtTime(783.99, now + 0.2); 
                    osc.frequency.setValueAtTime(1046.50, now + 0.3);
                    gainNode.gain.setValueAtTime(0, now);
                    gainNode.gain.linearRampToValueAtTime(0.5, now + 0.05);
                    gainNode.gain.linearRampToValueAtTime(0, now + 0.6);
                    osc.start(now); osc.stop(now + 0.6);
                } else if (type === 'wrong') {
                    osc.type = 'sawtooth';
                    osc.frequency.setValueAtTime(100, now);
                    osc.frequency.linearRampToValueAtTime(50, now + 0.5);
                    gainNode.gain.setValueAtTime(0.5, now);
                    gainNode.gain.linearRampToValueAtTime(0, now + 0.5);
                    osc.start(now); osc.stop(now + 0.5);
                } else if (type === 'draw') {
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(200, now);
                    osc.frequency.exponentialRampToValueAtTime(600, now + 0.2);
                    gainNode.gain.setValueAtTime(0.3, now);
                    gainNode.gain.linearRampToValueAtTime(0, now + 0.3);
                    osc.start(now); osc.stop(now + 0.3);
                }
            }
            
            else if (type === 'gunshot') {
                // Loud Air Horn
                const osc1 = audioCtx.createOscillator();
                const osc2 = audioCtx.createOscillator();
                const gain = audioCtx.createGain();

                osc1.type = 'sawtooth';
                osc2.type = 'sawtooth';
                
                osc1.frequency.setValueAtTime(330, now);
                osc2.frequency.setValueAtTime(335, now);

                gain.gain.setValueAtTime(0, now);
                gain.gain.linearRampToValueAtTime(0.6, now + 0.05);
                gain.gain.linearRampToValueAtTime(0.6, now + 0.6);
                gain.gain.exponentialRampToValueAtTime(0.001, now + 1.0);

                osc1.connect(gain);
                osc2.connect(gain);
                gain.connect(audioCtx.destination);

                osc1.start(now);
                osc2.start(now);
                osc1.stop(now + 1.0);
                osc2.stop(now + 1.0);
            } 
            
            else if (type === 'cheer') {
                // Happy Cheer
                const bufferSize = audioCtx.sampleRate * 3.0; 
                const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
                const data = buffer.getChannelData(0);
                
                let b0=0, b1=0, b2=0, b3=0, b4=0, b5=0, b6=0;
                for (let i = 0; i < bufferSize; i++) {
                    const white = Math.random() * 2 - 1;
                    b0 = 0.99886 * b0 + white * 0.0555179;
                    b1 = 0.99332 * b1 + white * 0.0750759;
                    b2 = 0.96900 * b2 + white * 0.1538520;
                    b3 = 0.86650 * b3 + white * 0.3104856;
                    b4 = 0.55000 * b4 + white * 0.5329522;
                    b5 = -0.7616 * b5 - white * 0.0168981;
                    data[i] = b0 + b1 + b2 + b3 + b4 + b5 + b6 + white * 0.5362;
                    data[i] *= 0.11; 
                    b6 = white * 0.115926;
                }
                
                const noise = audioCtx.createBufferSource();
                noise.buffer = buffer;
                
                const bandpass = audioCtx.createBiquadFilter();
                bandpass.type = 'highpass'; 
                bandpass.frequency.setValueAtTime(500, now);
                
                const noiseGain = audioCtx.createGain();
                noiseGain.gain.setValueAtTime(0, now);
                noiseGain.gain.linearRampToValueAtTime(0.8, now + 0.1); 
                noiseGain.gain.exponentialRampToValueAtTime(0.01, now + 3.0); 
                
                noise.connect(bandpass).connect(noiseGain).connect(audioCtx.destination);
                noise.start(now);

                // Victory Arpeggio
                const notes = [
                    { f: 523.25, t: 0 }, { f: 659.25, t: 0.1 }, { f: 783.99, t: 0.2 }, { f: 1046.50, t: 0.3 }, { f: 1318.51, t: 0.4 }
                ];

                notes.forEach(n => {
                    const osc = audioCtx.createOscillator();
                    osc.type = 'triangle'; 
                    osc.frequency.setValueAtTime(n.f, now + n.t);
                    
                    const gain = audioCtx.createGain();
                    gain.gain.setValueAtTime(0, now + n.t);
                    gain.gain.linearRampToValueAtTime(0.3, now + n.t + 0.05); 
                    gain.gain.exponentialRampToValueAtTime(0.001, now + n.t + 2.0);
                    
                    osc.connect(gain).connect(audioCtx.destination);
                    osc.start(now + n.t);
                    osc.stop(now + n.t + 2.5);
                });

                // Sparkles
                for(let i=0; i<5; i++) {
                    const osc = audioCtx.createOscillator();
                    osc.type = 'sine';
                    const freq = 1500 + Math.random() * 1000;
                    const startTime = now + 0.3 + (Math.random() * 0.5);
                    osc.frequency.setValueAtTime(freq, startTime);
                    const gain = audioCtx.createGain();
                    gain.gain.setValueAtTime(0, startTime);
                    gain.gain.linearRampToValueAtTime(0.1, startTime + 0.05);
                    gain.gain.exponentialRampToValueAtTime(0.001, startTime + 0.3);
                    osc.connect(gain).connect(audioCtx.destination);
                    osc.start(startTime);
                    osc.stop(startTime + 0.3);
                }
            }
        }

        function speak(text) {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'zh-TW';
                utterance.rate = 1.2; 
                utterance.pitch = 1.1;
                window.speechSynthesis.speak(utterance);
            }
        }

        // --- Navigation Logic ---
        function testSound() {
            ensureAudioContext();
            playSound('cheer'); 
            speak('ç³»çµ±éŸ³æ•ˆæ¸¬è©¦æ­£å¸¸');
        }

        function enterSystem() {
            ensureAudioContext();
            document.getElementById('startOverlay').style.display = 'none';
            document.getElementById('mainMenu').classList.remove('hidden-section');
            speak("æ­¡è¿ä¾†åˆ°è·‘è·‘å¡ä¸è»Šé›™äººå°æˆ°ç‰ˆ");
        }

        function switchMode(mode) {
            ensureAudioContext();
            document.getElementById('mainMenu').classList.add('hidden-section');
            if (mode === 'timer') {
                document.getElementById('timerMode').classList.remove('hidden-section');
                speak("é€²å…¥é›™äººç«¶é€Ÿæ¨¡å¼");
                resetDualStopwatch();
                startMusic();
            } else if (mode === 'quiz') {
                document.getElementById('quizMode').classList.remove('hidden-section');
                speak("é€²å…¥æ™ºåŠ›é—–é—œæ¨¡å¼");
                initQuizGame();
                startMusic();
            }
        }

        function backToMenu() {
            stopDualStopwatch();
            clearInterval(quizTimerInterval);
            clearInterval(quizRaceTimerInterval);
            stopMusic();
            document.getElementById('musicToggleBtn').classList.add('hidden-section');
            document.getElementById('timerMode').classList.add('hidden-section');
            document.getElementById('quizMode').classList.add('hidden-section');
            document.getElementById('mainMenu').classList.remove('hidden-section');
        }

        // --- Dual Timer & Leaderboard Logic ---
        let dualTimerInterval = null;
        let raceStartTime = 0;
        let isRacing = false;
        let p1Time = 0; let p2Time = 0;
        let p1Finished = false; let p2Finished = false;
        let raceResults = [];

        function startRaceSequence() {
            ensureAudioContext();
            resetDualStopwatch();
            playSound('gunshot');
            const panel = document.querySelector('#timerMode .bg-gray-900');
            panel.classList.add('bg-white');
            setTimeout(() => { panel.classList.remove('bg-white'); }, 100);

            isRacing = true;
            raceStartTime = Date.now();
            document.getElementById('btnP1').disabled = false;
            document.getElementById('btnP1').innerText = "ğŸ P1 æŠµé”";
            document.getElementById('btnP1').classList.remove('bg-gray-700');
            document.getElementById('btnP1').classList.add('bg-red-600');
            
            document.getElementById('btnP2').disabled = false;
            document.getElementById('btnP2').innerText = "ğŸ P2 æŠµé”";
            document.getElementById('btnP2').classList.remove('bg-gray-700');
            document.getElementById('btnP2').classList.add('bg-blue-600');
            dualTimerInterval = setInterval(updateDualDisplay, 10);
        }

        function updateDualDisplay() {
            const now = Date.now();
            const currentElapsed = now - raceStartTime;
            if (!p1Finished) { p1Time = currentElapsed; document.getElementById('timerDisplayP1').innerHTML = formatTime(p1Time); }
            if (!p2Finished) { p2Time = currentElapsed; document.getElementById('timerDisplayP2').innerHTML = formatTime(p2Time); }
        }

        function formatTime(ms) {
            const totalSeconds = Math.floor(ms / 1000);
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            const milliseconds = Math.floor((ms % 1000) / 10);
            return `${String(minutes).padStart(2,'0')}:${String(seconds).padStart(2,'0')}<span class="text-2xl md:text-3xl opacity-70">.${String(milliseconds).padStart(2,'0')}</span>`;
        }

        function formatTimeSimple(ms) {
            const totalSeconds = Math.floor(ms / 1000);
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            const milliseconds = Math.floor((ms % 1000) / 10);
            return `${String(minutes).padStart(2,'0')}:${String(seconds).padStart(2,'0')}.${String(milliseconds).padStart(2,'0')}`;
        }

        function playerFinish(player) {
            if (!isRacing) return;
            if (player === 1 && !p1Finished) {
                p1Finished = true; playSound('cheer');
                document.getElementById('btnP1').disabled = true; document.getElementById('btnP1').innerText = "å·²å®Œæˆ"; document.getElementById('btnP1').classList.add('bg-gray-700');
            } else if (player === 2 && !p2Finished) {
                p2Finished = true; playSound('cheer');
                document.getElementById('btnP2').disabled = true; document.getElementById('btnP2').innerText = "å·²å®Œæˆ"; document.getElementById('btnP2').classList.add('bg-gray-700');
            }
            if (p1Finished && p2Finished) { finishRace(); }
        }

        function finishRace() {
            clearInterval(dualTimerInterval); isRacing = false; speak("æ¯”è³½çµæŸ"); recordResult();
        }

        function stopDualStopwatch() { clearInterval(dualTimerInterval); isRacing = false; }

        function resetDualStopwatch() {
            stopDualStopwatch();
            p1Time = 0; p2Time = 0;
            p1Finished = false; p2Finished = false;
            document.getElementById('timerDisplayP1').innerHTML = formatTime(0);
            document.getElementById('timerDisplayP2').innerHTML = formatTime(0);
            const btn1 = document.getElementById('btnP1'); const btn2 = document.getElementById('btnP2');
            btn1.disabled = true; btn2.disabled = true;
            btn1.classList.add('bg-gray-700'); btn2.classList.add('bg-gray-700');
            btn1.innerText = "ç­‰å¾…èµ·è·‘"; btn2.innerText = "ç­‰å¾…èµ·è·‘";
        }

        function recordResult() {
            const winner = p1Time < p2Time ? "ğŸ”´ ç´…éšŠ" : "ğŸ”µ è—éšŠ";
            const result = {
                id: raceResults.length + 1,
                p1: formatTimeSimple(p1Time),
                p2: formatTimeSimple(p2Time),
                winner: p1Time === p2Time ? "å¹³æ‰‹" : winner
            };
            raceResults.unshift(result); renderLeaderboard();
        }

        function renderLeaderboard() {
            const tbody = document.getElementById('scoreTableBody');
            const badge = document.getElementById('raceCountBadge');
            const emptyState = document.getElementById('emptyState');
            badge.innerText = raceResults.length;
            if (raceResults.length > 0) { emptyState.style.display = 'none'; } else { emptyState.style.display = 'block'; }
            tbody.innerHTML = raceResults.map(r => `
                <tr class="bg-white border-b hover:bg-gray-50">
                    <td class="px-3 py-2 font-bold text-gray-900">#${r.id}</td>
                    <td class="px-3 py-2 text-red-600 font-bold">${r.p1}</td>
                    <td class="px-3 py-2 text-blue-600 font-bold">${r.p2}</td>
                    <td class="px-3 py-2 font-bold ${r.winner.includes('ç´…') ? 'text-red-600' : 'text-blue-600'}">
                        ${r.winner.includes('ç´…') ? 'ğŸ‘‘ ' : ''}${r.winner.includes('è—') ? 'ğŸ‘‘ ' : ''}${r.winner}
                    </td>
                </tr>
            `).join('');
        }

        function clearLeaderboard() {
            if(confirm("ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰æ¯”è³½ç´€éŒ„å—ï¼Ÿ")) { raceResults = []; renderLeaderboard(); }
        }

        // --- Quiz Race Mode Logic (Buzzer Edition) ---
        // Change from const to let to allow importing
        let originalQuestions = [
            { topic: "ä¸­æ­£ç´€å¿µå ‚", question: "è«‹å•ã€Œä¸­æ­£ç´€å¿µå ‚ã€çš„å…«è§’å½¢å±‹é ‚æ˜¯ä»€éº¼é¡è‰²çš„ï¼Ÿ", options: ["ç´…è‰²", "è—è‰²", "é»ƒè‰²"], answer: 1 },
            { topic: "åŒ—æŠ•æº«æ³‰", question: "ä¾†åˆ°åŒ—æŠ•æ—…éŠï¼Œæœ€è‘—åçš„ç‰¹è‰²é«”é©—æ˜¯ä»€éº¼ï¼Ÿ", options: ["æ³¡æº«æ³‰", "æ»‘é›ª", "è¡æµª"], answer: 0 },
            { topic: "è²“ç©ºçºœè»Š", question: "æ­ä¹˜è²“ç©ºçºœè»Šä¸Šå±±ï¼Œé™¤äº†å–èŒ¶ï¼Œé‚„å¯ä»¥çœ‹åˆ°ä»€éº¼æ™¯è‰²ï¼Ÿ", options: ["æ²™æ¼ ", "101å¤§æ¨“èˆ‡èŒ¶åœ’", "å†°å·"], answer: 1 },
            { topic: "å‹•ç‰©åœ’", question: "å°åŒ—å¸‚ç«‹å‹•ç‰©åœ’çš„è¶…äººæ°£æ˜æ˜Ÿã€Œåœ“åœ“ã€æ˜¯ä»€éº¼å‹•ç‰©ï¼Ÿ", options: ["ç…å­", "å¤§è²“ç†Š", "åœ‹ç‹ä¼éµ"], answer: 1 },
            { topic: "é™½æ˜å±±èŠ±é˜", question: "é™½æ˜å±±çš„è‘—ååœ°æ¨™ã€ŒèŠ±é˜ã€ï¼Œä¸»è¦æ˜¯ç”±ä»€éº¼çµ„æˆçš„ï¼Ÿ", options: ["æ™‚é˜èˆ‡èŠ±æœµ", "æ¨‚é«˜ç©æœ¨", "æ°´æ™¶ç»ç’ƒ"], answer: 0 },
            { topic: "æ•…å®®åšç‰©é™¢", question: "æ•…å®®çš„é®é¤¨ä¹‹å¯¶ã€Œç¿ ç‰ç™½èœã€ä¸Šï¼Œåœè‘—ä»€éº¼æ˜†èŸ²ï¼Ÿ", options: ["è´è¶", "è½æ–¯(ç´¡ç¹”å¨˜)", "ç”²èŸ²"], answer: 1 },
            { topic: "é¾å±±å¯º", question: "è¬è¯é¾å±±å¯ºæ˜¯å°åŒ—è‘—åçš„å¤è¹Ÿï¼Œä¸»è¦ä¾›å¥‰çš„ç¥æ˜æ˜¯ï¼Ÿ", options: ["è§€ä¸–éŸ³è©è–©", "è€¶ç©Œ", "è–èª•è€å…¬å…¬"], answer: 0 },
            { topic: "101å¤§æ¨“", question: "å°åŒ—101å¤§æ¨“æ›¾ç¶“æ˜¯ä¸–ç•Œæœ€é«˜æ¨“ï¼Œå®ƒçš„å¤–å‹åƒä»€éº¼ï¼Ÿ", options: ["ç«¹ç¯€", "é¦™è•‰", "çƒæ£’"], answer: 0 },
            { topic: "æ·¡æ°´è€è¡—", question: "å»æ·¡æ°´è€è¡—å¿…åƒçš„å°åƒã€Œé˜¿çµ¦ã€ï¼Œå¤–é¢åŒ…çš„æ˜¯ä»€éº¼ï¼Ÿ", options: ["éºµåŒ…", "æ²¹è±†è…", "è›‹çš®"], answer: 1 },
            { topic: "ç¾éº—è¯", question: "å¤§ç›´ç¾éº—è¯æœ€é¡¯çœ¼çš„åœ°æ¨™æ˜¯ä»€éº¼éŠæ¨‚è¨­æ–½ï¼Ÿ", options: ["é›²éœ„é£›è»Š", "æ—‹è½‰æœ¨é¦¬", "æ‘©å¤©è¼ª"], answer: 2 }
        ];

        // Backup for reset
        const defaultQuestionsBackup = JSON.parse(JSON.stringify(originalQuestions));

        let questions = [];
        let currentQuestion = null;
        let quizTimerInterval = null;
        let quizTimeLeft = 10;
        
        // Race specific variables
        let p1Pos = 0; // 0 to 6
        let p2Pos = 0; // 0 to 6
        let answeringTeam = 0; // 1 = P1, 2 = P2, 0 = None
        let quizRaceStartTime = 0;
        let quizRaceTimerInterval = null;
        const WINNING_POS = 6;

        function initQuizGame() {
            questions = [...originalQuestions];
            p1Pos = 0;
            p2Pos = 0;
            answeringTeam = 0;
            
            // UI Reset
            document.getElementById('resultOverlay').style.display = 'none';
            document.getElementById('winnerOverlay').style.display = 'none';
            
            // Start Race Timer
            quizRaceStartTime = Date.now();
            if(quizRaceTimerInterval) clearInterval(quizRaceTimerInterval);
            quizRaceTimerInterval = setInterval(updateQuizTotalTimer, 1000);
            updateQuizTotalTimer();
            
            updateTrackUI();
            
            document.getElementById('quizStatusBadge').innerText = "ç­‰å¾…æ¶ç­”";
            document.getElementById('quizStatusBadge').className = "px-4 py-1 rounded-full font-black bg-gray-600 text-white text-lg";
            speak("æ¯”è³½é–‹å§‹ï¼Œè«‹æ¶ç­”");
            
            // Load first question immediately
            loadNextQuestion();
        }

        // --- Question Settings Logic ---
        function openQuestionSettings() {
            document.getElementById('settingsOverlay').classList.remove('hidden');
            document.getElementById('jsonInput').value = JSON.stringify(originalQuestions, null, 2);
        }

        function closeSettings() {
            document.getElementById('settingsOverlay').classList.add('hidden');
        }

        function resetDefaultQuestions() {
            if(confirm('ç¢ºå®šè¦æ¨æ£„ç›®å‰è¨­å®šï¼Œæ¢å¾©ç‚ºé è¨­é¡Œç›®å—ï¼Ÿ')) {
                document.getElementById('jsonInput').value = JSON.stringify(defaultQuestionsBackup, null, 2);
            }
        }

        function saveCustomQuestions() {
            try {
                const input = document.getElementById('jsonInput').value;
                const parsed = JSON.parse(input);
                
                // Basic Validation
                if(!Array.isArray(parsed) || parsed.length === 0) throw new Error("å¿…é ˆæ˜¯åŒ…å«è³‡æ–™çš„é™£åˆ—");
                
                const valid = parsed.every(q => 
                    q.topic && 
                    q.question && 
                    Array.isArray(q.options) && 
                    q.options.length >= 2 && 
                    typeof q.answer === 'number'
                );

                if(!valid) throw new Error("é¡Œç›®æ ¼å¼éŒ¯èª¤ (ç¼ºå°‘å¿…è¦æ¬„ä½æˆ–é¸é …ä¸è¶³)");

                originalQuestions = parsed;
                alert(`æˆåŠŸåŒ¯å…¥ ${originalQuestions.length} é¡Œï¼æ¯”è³½å°‡é‡æ–°é–‹å§‹ã€‚`);
                closeSettings();
                initQuizGame(); // Restart game with new questions

            } catch (e) {
                alert("JSON æ ¼å¼éŒ¯èª¤ï¼š\n" + e.message);
            }
        }
        // ------------------------------

        function updateQuizTotalTimer() {
            const now = Date.now();
            const elapsed = Math.floor((now - quizRaceStartTime) / 1000);
            const m = Math.floor(elapsed / 60);
            const s = elapsed % 60;
            document.getElementById('quizTotalTimer').innerText = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
        }

        function updateTrackUI() {
            // Update Kart Positions
            const stepPercent = 100 / 7;
            const centerOffset = stepPercent / 2;
            const p1Left = (p1Pos * stepPercent) + centerOffset;
            const p2Left = (p2Pos * stepPercent) + centerOffset;
            
            document.getElementById('kartP1').style.left = p1Left + '%';
            document.getElementById('kartP2').style.left = p2Left + '%';

            // Highlight Active Cells
            for(let i=0; i<=6; i++) {
                document.getElementById(`p1-cell-${i}`).className = "flex-1 h-full border-r border-dashed border-gray-300 relative transition-colors duration-300";
                document.getElementById(`p2-cell-${i}`).className = "flex-1 h-full border-r border-dashed border-gray-300 relative transition-colors duration-300";
                
                if(i===0) {
                      document.getElementById(`p1-cell-${i}`).classList.add("flex", "items-center", "justify-center", "bg-gray-50", "text-xs", "font-bold", "text-gray-300");
                      document.getElementById(`p2-cell-${i}`).classList.add("flex", "items-center", "justify-center", "bg-gray-50", "text-xs", "font-bold", "text-gray-300");
                }
                if(i===6) {
                      document.getElementById(`p1-cell-${i}`).classList.add("bg-yellow-100", "flex", "items-center", "justify-center", "font-black", "text-xs", "text-yellow-600");
                      document.getElementById(`p2-cell-${i}`).classList.add("bg-yellow-100", "flex", "items-center", "justify-center", "font-black", "text-xs", "text-yellow-600");
                }
            }

            const p1Cell = document.getElementById(`p1-cell-${p1Pos}`);
            const p2Cell = document.getElementById(`p2-cell-${p2Pos}`);
            
            p1Cell.classList.remove("bg-gray-50", "bg-yellow-100");
            p1Cell.classList.add("active-cell-p1");
            
            p2Cell.classList.remove("bg-gray-50", "bg-yellow-100");
            p2Cell.classList.add("active-cell-p2");
        }

        function loadNextQuestion() {
            if (questions.length === 0) questions = [...originalQuestions];

            // Immediate transition
            const randomIndex = Math.floor(Math.random() * questions.length);
            currentQuestion = questions[randomIndex];
            questions.splice(randomIndex, 1);
            
            setupBuzzerPhase();
        }

        function setupBuzzerPhase() {
            document.getElementById('questionSection').classList.remove('hidden');
            document.getElementById('questionSection').classList.add('flex');
            
            // Show Topic & Question
            document.getElementById('topicTag').innerText = currentQuestion.topic;
            document.getElementById('questionText').innerText = currentQuestion.question;
            
            // Show Buzzers, Hide Options
            document.getElementById('buzzerArea').classList.remove('hidden');
            document.getElementById('buzzerArea').classList.add('flex');
            document.getElementById('optionsContainer').classList.add('hidden');
            document.getElementById('timerText').innerText = ""; 
            
            // Update Status
            document.getElementById('quizStatusBadge').innerText = "ç­‰å¾…æ¶ç­”";
            document.getElementById('quizStatusBadge').className = "px-4 py-1 rounded-full font-black bg-yellow-500 text-black text-lg animate-pulse";
            
            // speak("è«‹æ¶ç­”"); // Optional repetition
        }

        function teamBuzzIn(team) {
            answeringTeam = team;
            playSound('gunshot'); // Buzzer sound
            
            // Hide Buzzers
            document.getElementById('buzzerArea').classList.add('hidden');
            document.getElementById('buzzerArea').classList.remove('flex');
            
            // Show Options
            const optsContainer = document.getElementById('optionsContainer');
            optsContainer.innerHTML = '';
            optsContainer.classList.remove('hidden');
            
            // Status Update
            const teamName = team === 1 ? "ğŸ”´ ç´…éšŠ" : "ğŸ”µ è—éšŠ";
            const bgClass = team === 1 ? "bg-red-600" : "bg-blue-600";
            
            document.getElementById('quizStatusBadge').innerText = `${teamName} å›ç­”ä¸­`;
            document.getElementById('quizStatusBadge').className = `px-4 py-1 rounded-full font-black ${bgClass} text-white text-lg`;
            
            // Generate Options
            currentQuestion.options.forEach((opt, index) => {
                const btn = document.createElement('button');
                btn.className = 'option-btn w-full bg-white border-2 border-gray-300 p-4 rounded-xl text-lg font-bold text-gray-700 hover:bg-blue-50 hover:border-blue-400 transition mb-2 shadow-sm text-left';
                btn.innerText = (index + 1) + ". " + opt;
                btn.onclick = () => checkAnswer(index);
                optsContainer.appendChild(btn);
            });
            
            speak(`${team === 1 ? 'ç´…éšŠ' : 'è—éšŠ'}è«‹å›ç­”`);
            startQuizTimer();
        }

        function startQuizTimer() {
            quizTimeLeft = 10;
            const timerText = document.getElementById('timerText');
            const timerBar = document.getElementById('timerBar');
            timerText.innerText = quizTimeLeft;
            timerBar.style.width = '100%';
            timerBar.className = 'h-full bg-green-500 w-full';

            if (quizTimerInterval) clearInterval(quizTimerInterval);

            quizTimerInterval = setInterval(() => {
                quizTimeLeft--;
                timerText.innerText = quizTimeLeft;
                
                if (quizTimeLeft <= 5) timerBar.className = 'h-full bg-red-500 w-full';
                else if (quizTimeLeft <= 7) timerBar.className = 'h-full bg-yellow-400 w-full';
                
                timerBar.style.width = (quizTimeLeft * 10) + '%';
                if (quizTimeLeft >= 0) playSound('tick');
                if (quizTimeLeft <= 0) {
                    clearInterval(quizTimerInterval);
                    handleQuizTimeout();
                }
            }, 1000);
        }

        function handleQuizTimeout() {
            playSound('wrong');
            showResult(false, "æ™‚é–“åˆ°ï¼");
        }

        function checkAnswer(selectedIndex) {
            clearInterval(quizTimerInterval);
            const isCorrect = selectedIndex === currentQuestion.answer;
            
            if (isCorrect) {
                playSound('correct');
                // Move Forward
                if (answeringTeam === 1) p1Pos = Math.min(p1Pos + 1, WINNING_POS);
                else p2Pos = Math.min(p2Pos + 1, WINNING_POS);
                
                showResult(true);
            } else {
                playSound('wrong');
                // Penalty: Back to Start!
                if (answeringTeam === 1) p1Pos = 0;
                else p2Pos = 0;
                
                showResult(false, "ç­”éŒ¯äº†ï¼");
            }
            updateTrackUI();
        }

        function showResult(isCorrect, customTitle) {
            const overlay = document.getElementById('resultOverlay');
            const icon = document.getElementById('resultIcon');
            const title = document.getElementById('resultTitle');
            const msg = document.getElementById('resultMessage');
            
            overlay.style.display = 'flex';
            
            if (isCorrect) {
                icon.innerText = "â­•";
                icon.className = "text-8xl mb-4 text-green-500 animate-bounce";
                title.innerText = "ç­”å°äº†ï¼";
                title.className = "text-3xl font-black mb-2 text-green-700";
                msg.innerText = "è¡åˆºå‰é€²ä¸€æ­¥ï¼";
                
                // Check Win Condition immediately
                if ((answeringTeam === 1 && p1Pos === WINNING_POS) || (answeringTeam === 2 && p2Pos === WINNING_POS)) {
                    // Delay slightly to show correct feedback first, then win
                    setTimeout(() => handleWin(), 1000);
                    return;
                }
                
                speak("ç­”å°äº†ï¼Œå‰é€²ä¸€æ­¥");
            } else {
                icon.innerText = "ğŸ’¥";
                icon.className = "text-8xl mb-4 text-red-500 shake";
                title.innerText = customTitle || "ç­”éŒ¯äº†ï¼";
                title.className = "text-3xl font-black mb-2 text-red-700";
                msg.innerText = "å¼•æ“æ•…éšœ...é€€å›åŸé»ï¼";
                speak("å¾ˆéºæ†¾ï¼Œé€€å›åŸé»");
            }
        }

        function handleWin() {
            clearInterval(quizRaceTimerInterval);
            playSound('cheer');
            
            const overlay = document.getElementById('winnerOverlay');
            const title = document.getElementById('winnerTitle');
            const timeDisplay = document.getElementById('finalTime');
            
            const winnerName = answeringTeam === 1 ? "ğŸ”´ ç´…éšŠ" : "ğŸ”µ è—éšŠ";
            title.innerText = `${winnerName} ç²å‹ï¼`;
            timeDisplay.innerText = document.getElementById('quizTotalTimer').innerText;
            
            overlay.style.display = 'flex';
            speak(`æ­å–œ${winnerName}ç²å‹`);
        }

        function handleNextRound() {
            document.getElementById('resultOverlay').style.display = 'none';
            loadNextQuestion();
        }

        function resetGame() {
            initQuizGame();
        }
    </script>
</body>
</html>
